name: Build and test workflow

on:
  workflow_call:
    inputs:
      platform:
        description: "Platform"
        required: true
        type: string
      build_type:
        description: "Build type"
        required: true
        type: string

jobs:
  build:
    # Build platform
    runs-on: ${{ inputs.platform }}

    name: ${{ inputs.platform }}-${{ inputs.build_type }}

    # Build steps
    steps:
      # Step: Checkout
      - name: Checkout
        uses: actions/checkout@v4
        # Workaround for getting "git describe --tags" to work in cmake/get_version_from_git.cmake (Build step)
        with:
          fetch-depth: 0

        # Step: Set compiler (use system Clang for all macOS versions)
      - name: Set compiler (macOS Clang)
        if: runner.os == 'macOS'
        run: |
          echo "Using system Clang for ${{ inputs.platform }}"
          echo "CC=clang" >> "$GITHUB_ENV"
          echo "CXX=clang++" >> "$GITHUB_ENV"
          echo "Configured Clang toolchain: $(clang --version | head -n 1)"

      # Step: Set paths
      - name: Set paths
        id: paths
        run: |
          echo "build_dir=${{ github.workspace }}/build" >> $GITHUB_OUTPUT
          echo "ext_deps_dir=${{ github.workspace }}/external_dependencies" >> $GITHUB_OUTPUT
          echo "install_dir=${{ github.workspace }}/install" >> $GITHUB_OUTPUT

      - name: Install system-provided dependencies
        run: |
          brew install boost doxygen libaec libomp

      # Step: Set OpenMP environment variables (architecture-aware)
      - name: Set OpenMP environment variables
        run: |
          # Detect Homebrew prefix based on runner architecture
          if [ "${{ runner.arch }}" = "ARM64" ]; then
            HOMEBREW_PREFIX="/opt/homebrew"
          else
            HOMEBREW_PREFIX="/usr/local"
          fi
          
          echo "HOMEBREW_PREFIX=$HOMEBREW_PREFIX" >> $GITHUB_ENV
          echo "LDFLAGS=-L$HOMEBREW_PREFIX/opt/libomp/lib" >> $GITHUB_ENV
          echo "CPPFLAGS=-I$HOMEBREW_PREFIX/opt/libomp/include" >> $GITHUB_ENV
          echo "Debug: Checking OpenMP installation at $HOMEBREW_PREFIX:"
          ls -la "$HOMEBREW_PREFIX/opt/libomp/lib/" || echo "OpenMP lib directory not found"
          ls -la "$HOMEBREW_PREFIX/opt/libomp/include/" || echo "OpenMP include directory not found"
          file "$HOMEBREW_PREFIX/opt/libomp/lib/libomp.dylib" || echo "libomp.dylib not found"

      # Step: Restore cached user-provided dependencies
      - name: Restore cached user-provided dependencies
        uses: actions/cache/restore@v4
        id: restore-cached-external-dependencies
        with:
          key: ${{ inputs.platform }}-${{ inputs.build_type }}-cache-key-v4
          restore-keys: ${{ inputs.platform }}-${{ inputs.build_type }}-cache-key-v4
          path: ${{ steps.paths.outputs.ext_deps_dir }}/netcdf-c/install/netcdf-c

      # Step: Check if netCDF cache directory already has contents (defensive guard)
      - name: Check if netCDF cache is populated
        id: check-nc-cache
        run: |
          netcdf_dir="${{ steps.paths.outputs.ext_deps_dir }}/netcdf-c/install/netcdf-c"
          if [ -d "$netcdf_dir" ] && [ "$(ls -A "$netcdf_dir" 2>/dev/null)" ]; then
            echo "has-deps=true" >> "$GITHUB_OUTPUT"
          else
            echo "has-deps=false" >> "$GITHUB_OUTPUT"
          fi

      # Step: Build and install user-provided dependencies, executes only if no cache restored
      - name: Build and install user-provided dependencies
        if: steps.check-nc-cache.outputs.has-deps == 'false'
        # NetCDF Dependencies m4, curl, and openssl are provided by the build machine
        run: >
          pwsh ${{ github.workspace }}/scripts/install_netcdf_static.ps1
          -WorkDir ${{ steps.paths.outputs.ext_deps_dir }}/netcdf-c/work
          -InstallDir ${{ steps.paths.outputs.ext_deps_dir }}/netcdf-c/install
          -BuildType '${{ inputs.build_type }}'
          -ParallelJobs 10

      # Step: Cache user-provided dependencies, executes only if dependencies were built
      - name: Cache user-provided dependencies
        uses: actions/cache/save@v4
        if: steps.check-nc-cache.outputs.has-deps == 'false'
        with:
          key: ${{ inputs.platform }}-${{ inputs.build_type }}-cache-key-v4
          path: ${{ steps.paths.outputs.ext_deps_dir }}/netcdf-c/install/netcdf-c

      # Step: CMake configuration
      - name: Configure
        run: |
          SUPPRESS_PARAM_FLAG=""
          if [ "${{ inputs.platform }}" = "macos-15-intel" ]; then
            # Suppress unused parameter warnings on macOS 15 Intel runner (known platform-specific issue)
            SUPPRESS_PARAM_FLAG="-DSUPPRESS_UNUSED_PARAMETER_WARNING=ON"
          fi
          
          cmake \
            -S ${{ github.workspace }} \
            -B ${{ steps.paths.outputs.build_dir }} \
            -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} \
            -DCMAKE_PREFIX_PATH=${{ steps.paths.outputs.ext_deps_dir }}/netcdf-c/install/netcdf-c \
            -DCMAKE_INSTALL_PREFIX=${{ steps.paths.outputs.install_dir }} \
            $SUPPRESS_PARAM_FLAG \
            -DOpenMP_C_FLAGS="-Xpreprocessor -fopenmp -I$HOMEBREW_PREFIX/opt/libomp/include" \
            -DOpenMP_CXX_FLAGS="-Xpreprocessor -fopenmp -I$HOMEBREW_PREFIX/opt/libomp/include" \
            -DOpenMP_C_LIB_NAMES="omp" \
            -DOpenMP_CXX_LIB_NAMES="omp" \
            -DOpenMP_omp_LIBRARY="$HOMEBREW_PREFIX/opt/libomp/lib/libomp.dylib" \
            -DCMAKE_C_FLAGS="-Xpreprocessor -fopenmp -I$HOMEBREW_PREFIX/opt/libomp/include" \
            -DCMAKE_CXX_FLAGS="-Xpreprocessor -fopenmp -I$HOMEBREW_PREFIX/opt/libomp/include" \
            -DCMAKE_EXE_LINKER_FLAGS="-L$HOMEBREW_PREFIX/opt/libomp/lib -lomp" \
            -DCMAKE_SHARED_LINKER_FLAGS="-L$HOMEBREW_PREFIX/opt/libomp/lib -lomp"

      # Step: CMake build
      - name: Build
        run: cmake --build ${{ steps.paths.outputs.build_dir }} --config ${{ inputs.build_type }} -j 4

      # Step: Test (portable via ctest)
      - name: Test
        timeout-minutes: 10
        run: |
          # Create libz.1.dylib symlink needed for runtime linking
          if [ -f "${{ steps.paths.outputs.ext_deps_dir }}/netcdf-c/install/netcdf-c/bin/libz.dylib" ]; then
            ln -sf libz.dylib ${{ steps.paths.outputs.ext_deps_dir }}/netcdf-c/install/netcdf-c/bin/libz.1.dylib
          fi
          
          export DYLD_LIBRARY_PATH="${{ steps.paths.outputs.ext_deps_dir }}/netcdf-c/install/netcdf-c/bin:$DYLD_LIBRARY_PATH"
          ctest --test-dir ${{ steps.paths.outputs.build_dir }} \
                -C ${{ inputs.build_type }} \
                --output-on-failure

      # Step: CMake install
      - name: Install
        run: cmake --install ${{ steps.paths.outputs.build_dir }}

      # Step: Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: meshkernel-${{ inputs.platform }}-${{ inputs.build_type }}
          path: ${{ steps.paths.outputs.install_dir }}
          if-no-files-found: error
